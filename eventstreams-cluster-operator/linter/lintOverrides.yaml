###############################################################################
#
# Licensed Materials - Property of IBM
#
# 5737-H33
#
# (C) Copyright IBM Corp. 2020  All Rights Reserved.
#
# US Government Users Restricted Rights - Use, duplication or
# disclosure restricted by GSA ADP Schedule Contract with IBM Corp.
#
###############################################################################
overrides:
  # -------------------------------------------------------------------
  # overrides - rules we need to override
  # ----------------------------

  - rule: "NoInvalidAPIVersions"
    message: '^\[ERROR\] scanned-kafkamirrormaker2-[a-zA-Z0-9-:\.]+\.yaml:.*'
    reason: "KafkaMirrorMaker2 is only available in v1alpha1 version"

  - rule: "NoInvalidAPIVersions"
    message: '^\[ERROR\] scanned-operandrequest-[a-zA-Z0-9-:\.]+\.yaml:.*'
    reason: "OperandRequest is only available in v1alpha1 version"

  # TODO ensure deployment for release has a locked down version
  - rule: "NoLatestImageTags"
    message: '^\[ERROR\] scanned-deployment-\w+-eventstreams-operator\.yaml:.*'
    reason: "Set to latest for development purposes"
  - rule: "LatestTagHasPullPolicyAlways"
    message: '^\[ERROR\] scanned-deployment-\w+-eventstreams-operator\.yaml:.*'
    reason: "Set to latest for development purposes"
  # TODO lock down versions
  - rule: "NoLatestImageTags"
    message: '^\[ERROR\] scanned-deployment-[\w-]+-(entity|strimzi-cluster)-operator\.yaml:.*'
    reason: "Set to latest for development purposes"

  - rule: "NoAlphaAnnotations"
    message: '^\[ERROR\] scanned-service-[\w-]+-(kafka-brokers|zookeeper-nodes)\.yaml:.*'
    reason: "Annotations used for older versions of kubernetes that need supporting by Open Source Strimzi - EventStreams does not use these annotations"

  - rule: "PodHasArchBasedNodeAffinity"
    reason: "Implementing fat manifests, this no longer applies"

  - rule: "RequiredMetadataLabelsDefined"
    message: '^\[ERROR\] scanned-eventstreams-[\w-]+\.yaml:.*'
    reason: "User configured CR does not require labels"

  - rule: "RequiredMetadataLabelsDefined"
    message: '^\[ERROR\] scanned-eventstreamsgeoreplicator-[a-zA-Z0-9-:\.]+\.yaml:.*'
    reason: "User configured CR does not require labels"

  - rule: "RequiredMetadataLabelsDefined"
    message: '^\[ERROR\] scanned-kafkatopic-\w+-.*'
    reason: "KafkaTopics autogenerated on startup, we do not control the labels and they can be considered a user configured CR"

  - rule: "RequiredMetadataLabelsDefined"
    message: '^\[ERROR\] scanned-secret-[\w-]+-ibm-es-oidc-secret\.yaml:.*'
    reason: "The OIDC secret, created and managed by the OIDC operator does not have any way to configure labels"

  - rule: "RequiredMetadataLabelsDefined"
    message: '^\[ERROR\] scanned-secret-[\w-]+-ibm-es-ui-service-cert\.yaml:.*'
    reason: "THe service cert is generated by openshift, its labels cannot be configured by us"

  - rule: "RequiredMetadataLabelsDefined"
    message: '^\[ERROR\] scanned-secret-\w+-ibm-entitlement-key\.yaml:.*'
    reason: "User Image Pull Secret does not require labels"

  - rule: "PodSecurityContextDefined"
    message: '^\[ERROR\].*\.securityContext\.runAsUser \(PodSecurityContextDefined\)$'
    reason: "OpenShift requires all containers to run as Any UID, setting the runAsUser would cause conflicts with the restricted SCC"

  - rule: "RequiredMetadataLabelsDefined"
    message: '^\[ERROR\] scanned-(service|secret|configmap)-\w+-eventstreams-cluster-operator\.yaml:.*'
    reason: "Service, configmap and secret generated by OLM can not be configured"

##############################
# CV LINTER BUGS
##############################

  # TODO report namespace default resources being picked up by scan to linter team
  - rule: "RequiredMetadataLabelsDefined"
    message: '^\[ERROR\] scanned-rolebinding-\w+-system:[a-zA-Z-]+\.yaml:.*'
    reason: "These files are OpenShift default files and shouldn't be scanned"
  - rule: "ResourceNameIsValid"
    message: '^\[ERROR\] scanned-rolebinding-\w+-system:[a-zA-Z-]+\.yaml:.*'
    reason: "These files are OpenShift default files and shouldn't be scanned"
  - rule: "RequiredMetadataLabelsDefined"
    message: '^\[ERROR\] scanned-(rolebinding|serviceaccount)-\w+-(admin|builder|default|deployer)\.yaml:.*'
    reason: "These are default resources and should not be scanned"

  # TODO report that imagestream does not need to be picked up and scanned
  - rule: "RequiredMetadataLabelsDefined"
    message: '^\[ERROR\] scanned-(imagestream|imagestreamtag)-[a-zA-Z0-9-:\.]+\.yaml:.*'
    reason: "These are generated resources and should not be scanned"
  - rule: "ResourceNameIsValid"
    message: '^\[ERROR\] scanned-imagestreamtag-[a-zA-Z0-9-:\.]+\.yaml:.*'
    reason: "These are generated resources and should not be scanned"

  - rule: "RequiredMetadataLabelsDefined"
    message: '^\[ERROR\] scanned-monitoringdashboard-\w+-(helm-release-monitoring|kubernetes-pod-overview)\.yaml:.*'
    reason: "OpenShift default dashboards should not be scanned"

  - rule: "RequiredMetadataLabelsDefined"
    message: '^\[ERROR\] scanned-operatorgroup-\w+-[a-zA-Z0-9-:\.]+\.yaml:.*'
    reason: "OLM generated Operator Groups should not be scanned"
    